# HIK 三层架构实现说明

## 概述

HIK 操作系统采用三层架构设计，实现了从微内核到用户应用的完整隔离和通信机制。

## 架构层次

### Core-0: 微内核层
- **角色**: 系统协调者、资源管理者
- **执行环境**: x86 Ring 0, ARMv8-A EL2/EL3
- **核心功能**:
  - 能力系统（Capability System）
  - 内存管理（Physical Memory Manager）
  - 服务管理（Service Manager for Core-1）
  - 进程管理（Process Manager for Core-3）
  - 隔离执行（Isolation Enforcement）
  - IPC 路由（IPC Routing）

### Core-1: 特权服务层（Privileged-1 Layer）
- **角色**: 系统功能的模块化提供者
- **执行环境**: x86 Ring 0, ARMv8-A EL1/EL2
- **核心特性**:
  - 物理内存直接映射（Identity Mapping）
  - 独立的物理地址空间
  - 基于能力的资源访问
  - 零拷贝 IPC 通信
  - 故障隔离与恢复

### Core-3: 应用层（Application-3 Layer）
- **角色**: 不可信用户代码执行环境
- **执行环境**: x86 Ring 3, ARMv8-A EL0
- **核心特性**:
  - 标准进程抽象
  - 虚拟地址空间
  - 系统调用接口
  - IPC 客户端库

## 目录结构

```
HIK/
├── Core-0/              # 微内核层
│   ├── include/         # 头文件
│   ├── arch/            # 架构相关代码
│   ├── mm/              # 内存管理
│   ├── sched/           # 调度器
│   ├── capability/      # 能力系统
│   ├── service/         # 服务管理
│   ├── process/         # 进程管理
│   ├── irq/             # 中断处理
│   ├── isolation/       # 隔离执行
│   └── startup/         # 启动代码
├── Core-1/              # 特权服务层
│   ├── include/         # 头文件
│   ├── arch/            # 架构相关代码
│   ├── mm/              # 物理内存管理
│   ├── ipc/             # IPC 实现
│   ├── service/         # 服务框架
│   ├── isolation/       # 隔离执行
│   ├── lib/             # 库函数
│   └── examples/        # 示例服务
└── Core-3/              # 应用层
    ├── include/         # 头文件
    ├── mm/              # 虚拟内存管理
    ├── ipc/             # IPC 库
    ├── lib/             # 库函数
    └── examples/        # 示例应用
```

## 核心设计原则

### 1. 能力驱动安全（Capability-Based Security）
- 所有资源访问必须通过能力令牌
- 能力不可伪造，可受限传递
- 最小权限原则

### 2. 物理隔离（Physical Isolation）
- Core-1 服务运行在独立的物理内存区域
- MMU 页表权限强制隔离
- 故障限制在单个服务域内

### 3. 零拷贝通信（Zero-Copy IPC）
- 共享内存通道
- 无锁环形缓冲区
- 内存屏障同步

### 4. 故障隔离（Fault Isolation）
- 服务崩溃不影响其他服务
- 自动故障检测和恢复
- 监视器服务协调恢复

## 构建系统

### 构建 Core-0
```bash
cd Core-0
make
```

### 构建 Core-1 服务
```bash
cd Core-1
make
```

### 构建 Core-3 应用
```bash
cd Core-3
make
```

## 示例组件

### Core-1 示例服务
- **网络服务** (examples/network_service.c)
  - 提供网络功能
  - IPC 端点: "network"
  - 支持发送/接收/状态查询

### Core-3 示例应用
- **Hello World** (examples/hello_app.c)
  - 演示基本应用功能
  - 进程 ID 获取
  - 内存分配
  - IPC 调用

## IPC 通信模型

### 服务间通信（Core-1 ↔ Core-1）
- 直接共享内存通道
- 零拷贝数据传输
- 无锁环形缓冲区

### 应用与服务通信（Core-3 ↔ Core-1）
- 通过 Core-0 路由
- 系统调用接口
- 能力验证

### 应用间通信（Core-3 ↔ Core-3）
- 通过服务中转
- 间接消息传递
- 能力授权

## 内存管理

### Core-0
- 全局物理内存位图
- 域内存分配
- 页表管理

### Core-1
- 物理内存直接映射
- 堆分配器
- 无虚拟内存开销

### Core-3
- 虚拟地址空间
- 标准堆分配器
- 页表映射

## 故障处理

### 服务故障（Core-1）
1. Core-0 捕获异常
2. 终止服务域内线程
3. 回收资源和能力
4. 通知监视器服务
5. 监视器决定是否重启

### 应用故障（Core-3）
1. Core-0 捕获异常
2. 终止应用进程
3. 回收虚拟内存
4. 通知父进程

## 扩展性

### 添加新服务（Core-1）
1. 创建服务源文件
2. 实现服务回调
3. 注册 IPC 端点
4. 编译为二进制
5. 通过 Core-0 加载

### 添加新应用（Core-3）
1. 创建应用源文件
2. 实现 main 函数
3. 使用系统调用和 IPC
4. 编译为二进制
5. 通过 Core-0 加载

## 安全特性

1. **能力系统**: 所有资源访问需要能力令牌
2. **内存隔离**: MMU 页表权限强制隔离
3. **故障隔离**: 故障限制在单个域内
4. **最小权限**: 服务和应用只获得必要权限
5. **不可伪造**: 能力令牌不可伪造
6. **可审计**: 所有能力传递可追踪

## 性能优化

1. **物理映射**: Core-1 无虚拟地址转换开销
2. **零拷贝 IPC**: 共享内存避免数据复制
3. **无锁数据结构**: 环形缓冲区使用内存屏障
4. **批处理**: 批量化 IPC 消息

## 未来工作

1. 实现完整的服务示例（文件系统、显示服务）
2. 实现完整的应用示例
3. 添加更多系统调用
4. 优化 IPC 性能
5. 添加实时支持
6. 实现多核支持
7. 添加电源管理
8. 实现安全启动

## 参考资料

- [三层模型.md](./三层模型.md)
- [可移植性.md](./可移植性.md)
- [引导加载程序.md](./引导加载程序.md)